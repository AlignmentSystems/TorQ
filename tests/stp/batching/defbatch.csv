action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,batch1:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create batch of 10"
before,0,0,q,batch2:(1?`4;1?100.0;1?100i;1#0b;1?.Q.A;1?.Q.A;1#`buy),1,,"Create batch of 1"
before,0,0,q,trade:flip `time`sym`price`size`stop`cond`ex`side!"PSFIBCCS" $\: (),1,,"Create local trade table schema"
before,0,0,q,upd:{[t;x] t insert x},1,,"Define local UPD function"
before,0,0,q,"rdbHandle:hopen `$""::"",string[2+""J""$getenv[`KDBBASEPORT]],"":admin:admin""",1,,"Open handle to RDB"
before,0,0,q,"stpHandle:hopen `$""::"",string[24+""J""$getenv[`KDBBASEPORT]],"":admin:admin""",1,,"Open handle to STP"
before,0,0,q,stpHandle(`init;`defaultbatch),1,,"Set STP to defaultbatch mode"
before,0,0,q,![-11;] each logs:last flip stpHandle".stplg.replaylog[`trade]",1,,"Replay logs"
before,0,0,q,l1:count trade,1,,"Get initial trade logs count"
before,0,0,q,delete from `trade,1,,"Clear local trade table"
before,0,0,q,c1:rdbHandle"count trade",1,,"Get initial trade table count"
before,0,0,q,hclose rdbHandle,1,,"Close RDB handle"
before,0,0,q,a:"q" in' b:@[system;"pgrep -lf rdb1";`down],1,,"Get RDB PID info"
before,0,0,q,"system ""kill -9 "",first "" "" vs first b where a",1,,"Kill it"
true,0,0,q,stpHandle".stplg.ts~.stplg.zts[`defaultbatch]",1,,"Check correct batching mode is set"
run,0,0,q,stpHandle(`.u.upd;`trade;batch1),1,,"Publish first batch to STP"
run,0,0,q,system "sleep 1",1,,"Give data a chance to publish"
run,0,0,q,stpHandle(system;"t 0"),1,,"Turn off automatic publish"
run,0,0,q,stpHandle(`.u.upd;`trade;batch2),1,,"Publish second batch to STP"
run,0,0,q,"system getenv[`TORQHOME],""/torq.sh start rdb1 > /dev/null && sleep 1""",1,,"Start RDB"
run,0,0,q,"rdbHandle:hopen `$""::"",string[2+""J""$getenv[`KDBBASEPORT]],"":admin:admin""",1,,"Open handle to RDB"
run,0,0,q,![-11;] each logs,1,,"Replay logs locally"
true,0,0,q,(l1+11)~l2:count trade,1,,"Check logs contain both batches"
true,0,0,q,(c1+10)~c2:rdbHandle"count trade",1,,"Check first batch was successfully replayed from log"
run,0,0,q,stpHandle".z.ts[]",1,,"Resume publication"
true,0,0,q,(c2+1)~rdbHandle"count trade",1,,"Check second batch gets published"
after,0,0,q,delete from `trade,1,,"Clear local trade table"